# Barrier Prioritization {.unnumbered}

```{python}
#| echo: false
#| warning: false

import pandas as pd
import numpy as np
import warnings
import requests
import json
import pandas

def barrier_extent(barrier_type):

    request = 'https://cabd-pro.cwf-fcf.org/bcfishpass/functions/postgisftw.wcrp_barrier_extent/items.json?watershed_group_code=LNIC&barrier_type=' + barrier_type

    response_api = requests.get(request)
    parse = response_api.text
    result = json.loads(parse)

    blocked_km = result[0]['all_habitat_blocked_km']
    blocked_pct = result[0]['extent_pct']

    return blocked_km, blocked_pct

def barrier_count(barrier_type):
    request = 'https://cabd-pro.cwf-fcf.org/bcfishpass/functions/postgisftw.wcrp_barrier_count/items.json?watershed_group_code=LNIC&barrier_type=' + barrier_type

    response_api = requests.get(request)
    parse = response_api.text
    result = json.loads(parse)

    n_passable = result[0]['n_passable']
    n_barrier = result[0]['n_barrier']
    n_potential = result[0]['n_potential']
    n_unknown = result[0]['n_unknown']

    sum_bar = (n_passable, n_barrier, n_potential, n_unknown)

    return n_passable, n_barrier, n_potential, n_unknown, sum(sum_bar)

def barrier_severity(barrier_type):

    request = 'https://cabd-pro.cwf-fcf.org/bcfishpass/functions/postgisftw.wcrp_barrier_severity/items.json?watershed_group_code=LNIC&barrier_type=' + barrier_type

    response_api = requests.get(request)
    parse = response_api.text
    result = json.loads(parse)

    n_assessed_barrier = result[0]['n_assessed_barrier']
    n_assess_total = result[0]['n_assess_total']
    pct_assessed_barrier = result[0]['pct_assessed_barrier']

    return n_assessed_barrier, n_assess_total, pct_assessed_barrier

def watershed_connectivity(habitat_type):

    request = 'https://cabd-pro.cwf-fcf.org/bcfishpass/functions/postgisftw.wcrp_habitat_connectivity_status/items.json?watershed_group_code=LNIC&habitat_type=' + habitat_type

    response_api = requests.get(request)
    parse = response_api.text
    result = json.loads(parse)

    connect_stat = result[0]['connectivity_status']
    all_habitat = result[0]['all_habitat']
    all_habitat_acc = result[0]['all_habitat_accessible']

    return str(round(connect_stat,2)), all_habitat, all_habitat_acc

warnings.filterwarnings('ignore')

total = watershed_connectivity("ALL")[1] #total km in HORS
access = watershed_connectivity("ALL")[2]
gain = round((total*0.96)-access,2)
```

```{r}
#| echo: false
#| warning: false

library(reticulate)

gain <- py$gain

```

## Lower Nicola Watershed Barrier Prioritization Summary {.unnumbered}

One conservation outcome of the WCRP is the remediation of barriers to connectivity in the Lower Nicola River watershed, including lateral barriers to thermal refugia and longitudinal barriers. As a step toward the selection of projects for implementation to improve connectivity in the watershed, candidate barriers were prioritized to guide field verification of the sites through barrier assessments and habitat confirmations. The barrier prioritization results represent the best available knowledge at the time of publishing and the barrier lists will be iteratively updated over time.

### Lateral Barriers (Including to thermal refugia) {.unnumbered}

There is a lack of comprehensive data and mapping of lateral barriers and potential thermal refugia in the watershed to support a strategic prioritization currently (see Action 1.3). However, local knowledge was used to compile a list of candidate sites for field verification as a starting point to improve lateral and thermal connectivity.

```{r remove, echo = FALSE, results = 'asis'}
#| label: tbl-lateral
#| tbl-cap: "Identified priority lateral barrier remediation sites for field assessment in the Lower Nicola River watershed. UTM northing and eastings refer to Zone 10."
#| warning: false
#| echo: false

library("flextable")

data <- read.csv("data/lateral_barriers.csv", check.names=FALSE)
ft <- flextable(data) |> colformat_num(big.mark = "", decimal.mark = ".", digits = 2) 
ft <- bg(ft, bg = "#008270", part = "header")
ft <- color(ft, color = "white", part = "header")
ft <- set_caption(ft)
ft <- align_text_col(ft, align = "left", header = TRUE)
ft <- align_nottext_col(ft, align = "left", header = TRUE)
ft |> autofit() 
```

### Longitudinal Barriers {.unnumbered}

To achieve Goals 2 and 3 in this plan, it is necessary to prioritize and identify a suite of barriers that, if remediated, will provide access to a minimum of 69.33 km of modelled rearing habitat (@tbl-table16).

```{python echo=FALSE}
#| label: tbl-table16
#| tbl-cap: "Rearing habitat connectivity gain requirements to meet WCRP goals in the Lower Nicola River watershed. The measures of currently accessible and total habitat values are derived from the intrinsic potential habitat model described in [connectivity status](content/connectivity-status.qmd)."
#| warning: false
#| echo: false

import pandas as pd
import numpy as np
import matplotlib as mpl
import warnings

warnings.filterwarnings('ignore')

total = watershed_connectivity("REARING")[1] #total km in HORS
access = watershed_connectivity("REARING")[2]
gain = round((total*0.96)-access,2)

df = pd.DataFrame({"Habitat Type":["Rearing"],
                   "Currently accessible (km)":[str(round(access,2))],
                   "Total": [str(round(total,2))],
                   "Current Connectivity Status":[str(watershed_connectivity("REARING")[0])+"%"],
                   "Goal": ["96%"],
                   "Gain required (km)": [str(gain)]
                   })

data = df.style.hide().set_properties(**{'text-align': 'left'})

data.set_table_styles(
   [{
       'selector': 'th',
       'props': [('background-color', '#008270'),('text-align', 'left')]
   }])

```

The barrier prioritization process comprises three stages:

Stage 1: preliminary barrier list

Stage 2: intermediate barrier list

Stage 3: priority barrier list

Initially, the barrier prioritization analysis ranked all barriers in the watershed by the amount of habitat blocked to produce a "preliminary barrier list", which also accounted for assessing "sets" of barriers for which remediation could be coordinated to maximize connectivity gains. From this list, the top-ranking subset of barriers - comprising more barriers than are needed to achieve the goals - is selected to produce an "intermediate barrier list". Barriers that did not rank highly in the model results, but were identified as priority barriers by the local partners were also added to the intermediate barrier list. A longer list of barriers is needed due to the inherent assumptions and uncertainty in the connectivity and habitat models and gaps in available data. Barriers that have been modelled (i.e., points where streams and road/rail networks intersect) are assumed to be barriers until field verification is undertaken and structures that have been assessed as "potential" barriers (e.g., may be passable at certain flow levels or for certain life history stages) require further investigation before a definitive remediation decision is made. Additionally, the habitat model identifies stream segments that have the potential to support spawning or rearing habitat for target species but does not attempt to quantify [habitat quality or suitability](data-methods.qmd), which will require additional field verification once barrier assessments have completed. As such, the intermediate barrier list below (@tbl-intermediate) should be considered as a starting point in the prioritization process and represents structures that are a priority to evaluate further through barrier assessment and habitat confirmations because some structures will likely be passable, others will not be associated with usable habitat, and others may not be feasible to remediate because of logistic considerations.

The intermediate barrier list was updated following the barrier assessments and habitat confirmations that were undertaken during the 2021 field season - some barriers were moved forward to the "priority barrier list" (@tbl-priority) and others were eliminated from consideration due to one or more of the considerations discussed in @tbl-remove. The priority barrier list represents structures that were confirmed to be partial or full barriers to fish passage and that block access to confirmed habitat. Barriers on the priority list were reviewed by planning team members and selected for inclusion for proactive pursual of remediation. For more details on the barrier prioritization model, please see @Mazany-Wright2021-rz.

```{r remove, echo = FALSE, results = 'asis'}
#| label: tbl-remove
#| tbl-cap: "Crossings removed from the intermediate barriers list following field investigations."
#| warning: false
#| echo: false

library("flextable")

data <- read.csv("data/excluded_structures_table.csv", check.names=FALSE)
ft <- flextable(data) |> colformat_num(big.mark = "", decimal.mark = ".", digits = 2) 
ft <- bg(ft, bg = "#008270", part = "header")
ft <- color(ft, color = "white", part = "header")
ft <- set_caption(ft)
ft <- align_text_col(ft, align = "left", header = TRUE)
ft <- align_nottext_col(ft, align = "left", header = TRUE)
ft |> autofit() 
```

```{r deficient, echo = FALSE, results = 'asis'}
#| label: tbl-intermediate
#| tbl-cap: "Intermediate barrier list resulting from the barrier prioritization analysis in the Lower Nicola River watershed. The barriers on this list require further assessment and/or monitoring before being actively pursued for design and remediation. All barrier assessment data are compiled from the BC Provincial Stream Crossing Inventory System."
#| warning: false
#| echo: false

library("flextable")

data <- read.csv("data/intermediate_structures_table.csv", check.names=FALSE)
inter_num <- length(data)
ft <- flextable(data) |> colformat_num(big.mark = "", decimal.mark = ".", digits = 2) 
ft <- bg(ft, bg = "#008270", part = "header")
ft <- color(ft, color = "white", part = "header")
ft <- set_caption(ft)
ft <- align_text_col(ft, align = "left", header = TRUE)
ft <- align_nottext_col(ft, align = "left", header = TRUE)
ft |> autofit() 
```

```{r priority, echo = FALSE, results = 'asis'}
#| label: tbl-priority
#| tbl-cap: "Priority barrier list resulting from the barrier prioritization analysis in the Lower Nicola River watershed. The barriers on this have been selected for proactive remediation. All barrier assessment data are compiled from the BC Provincial Stream Crossing Inventory System."
#| warning: false
#| echo: false

library("flextable")

data <- read.csv("data/priority_barriers_for_rehabilitation_table.csv", check.names=FALSE)
prior_num <- length(data)
ft <- flextable(data) |> colformat_num(big.mark = "", decimal.mark = ".", digits = 2) 
ft <- bg(ft, bg = "#008270", part = "header")
ft <- color(ft, color = "white", part = "header")
ft <- set_caption(ft)
ft <- align_text_col(ft, align = "left", header = TRUE)
ft <- align_nottext_col(ft, align = "left", header = TRUE)
ft |> autofit() 
```


```{python}
#| label: tbl-remove1
#| tbl-cap: "List of barriers that were removed from consideration from first iteration of the intermediate barrier list (field assessments occurred during the 2021 field season). Removed following discussion with the planning team due to these structures not existing, being passable, not be associated with usable habitat, or deemed not feasible to remediate because of logistic considerations."
#| warning: false
#| echo: false
#| 
import pandas as pd

df = pd.read_csv('data/excluded_structures_table.csv')

data = df.style.hide().set_properties(**{'text-align': 'left'})

data.set_table_styles(
   [{
       'selector': 'th',
       'props': [('background-color', '#008270'),('text-align', 'left')]
   }])
```


